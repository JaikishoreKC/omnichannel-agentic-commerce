# API Contracts Specification (v1)

## Overview

This document defines the current REST and WebSocket contracts implemented in the
codebase.

Base paths:

- REST: `/v1`
- WebSocket: `/ws`

Local defaults:

- REST base URL: `http://localhost:8000/v1`
- WebSocket URL: `ws://localhost:8000/ws`

## Naming And Serialization

- JSON request/response fields use `camelCase`.
- Python service/domain models use `snake_case` internally.
- Path params in route signatures currently use `snake_case` names (for example,
  `{product_id}` and `{order_id}`).

## Authentication Model

### Access Tokens

- Authorization header format:

```text
Authorization: Bearer <access_token>
```

- Token algorithm: `HS256`.
- Access token TTL default: `900` seconds.
- Refresh token TTL default: `604800` seconds.
- Refresh tokens rotate on successful `/auth/refresh`.

### Anonymous Session Model

Anonymous browse/cart flows use one of:

- `X-Session-Id` header, or
- `session_id` cookie (set by cart/session dependency when needed).

## Standard Error Shape

Validation and runtime errors are normalized to:

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid request data",
    "details": [
      {
        "field": "email",
        "message": "Invalid value"
      }
    ]
  }
}
```

Common codes:

- `VALIDATION_ERROR`
- `AUTH_REQUIRED`
- `FORBIDDEN`
- `NOT_FOUND`
- `CONFLICT`
- `RATE_LIMITED`
- `INTERNAL_ERROR`

## REST Endpoints

## Public / Anonymous-Capable

### Health And Ops

- `GET /health`
- `GET /metrics`

### Auth

- `POST /auth/register`
- `POST /auth/login`
- `POST /auth/refresh`

Notes:

- `register` and `login` may include `sessionId` in response.
- Guest cart/session are merged/linked when a session is present.

Example register request:

```json
{
  "email": "user@example.com",
  "password": "SecurePass123!",
  "name": "John Doe",
  "phone": "+15551234567",
  "timezone": "America/Chicago"
}
```

Example register response (shape):

```json
{
  "user": {
    "id": "user_000001",
    "email": "user@example.com",
    "name": "John Doe",
    "role": "customer",
    "createdAt": "2026-02-23T00:00:00+00:00",
    "identity": {
      "anonymousId": "anon_session_000001",
      "linkedChannels": [
        {
          "provider": "web",
          "externalId": "session_000001"
        }
      ]
    }
  },
  "accessToken": "<jwt>",
  "refreshToken": "<jwt>",
  "expiresIn": 900,
  "sessionId": "session_000001"
}
```

### Products

- `GET /products`
- `GET /products/{product_id}`

`GET /products` query params:

- `query`
- `category`
- `brand`
- `minPrice`
- `maxPrice`
- `page` (default `1`)
- `limit` (default `20`, max `100`)

### Cart

- `GET /cart`
- `POST /cart/items`
- `PUT /cart/items/{item_id}`
- `DELETE /cart/items/{item_id}`
- `POST /cart/apply-discount`

`POST /cart/items` request:

```json
{
  "productId": "prod_001",
  "variantId": "var_001",
  "quantity": 1
}
```

### Sessions

- `POST /sessions`
- `GET /sessions/{session_id}`
- `DELETE /sessions/{session_id}`

`POST /sessions` request:

```json
{
  "channel": "web",
  "initialContext": {}
}
```

Response:

```json
{
  "sessionId": "session_000001",
  "anonymousId": "anon_session_000001",
  "expiresAt": "2026-02-23T00:30:00+00:00"
}
```

### Interactions

- `POST /interactions/message`
- `GET /interactions/history`

`POST /interactions/message` request:

```json
{
  "sessionId": "session_000001",
  "content": "show me running shoes",
  "channel": "web"
}
```

Response envelope:

```json
{
  "type": "response",
  "sessionId": "session_000001",
  "payload": {
    "message": "I found 3 options...",
    "agent": "product",
    "data": {},
    "suggestedActions": [],
    "metadata": {
      "intent": "product_search",
      "confidence": 0.84,
      "success": true
    }
  }
}
```

`GET /interactions/history`:

- For guest users, `sessionId` query param is required.
- For authenticated users, `sessionId` is optional and server resolves/rehydrates
  the best user session.

### Voice Callback

- `POST /voice/superu/callback`

Required headers:

- `X-SuperU-Signature` or `X-Signature`
- `X-SuperU-Timestamp` or `X-Timestamp`

## Authenticated Endpoints

### Orders

- `POST /orders`
- `GET /orders`
- `GET /orders/{order_id}`
- `POST /orders/{order_id}/cancel`
- `POST /orders/{order_id}/refund`
- `PUT /orders/{order_id}/shipping-address`

`POST /orders` requirements:

- Bearer token required.
- `Idempotency-Key` header required.

`POST /orders` request:

```json
{
  "shippingAddress": {
    "name": "John Doe",
    "line1": "123 Main St",
    "city": "Austin",
    "state": "TX",
    "postalCode": "78701",
    "country": "US"
  },
  "paymentMethod": {
    "type": "card",
    "token": "pm_test_123"
  }
}
```

### Memory

- `GET /memory`
- `GET /memory/preferences`
- `PUT /memory/preferences`
- `GET /memory/history`
- `DELETE /memory`
- `DELETE /memory/preferences`
- `DELETE /memory/preferences/{key}`
- `DELETE /memory/history`

## Admin Endpoints (Role = admin)

- `GET /admin/stats`
- `GET /admin/categories`
- `GET /admin/categories/records`
- `POST /admin/categories`
- `PUT /admin/categories/{category_id}`
- `DELETE /admin/categories/{category_id}`
- `POST /admin/products`
- `PUT /admin/products/{product_id}`
- `DELETE /admin/products/{product_id}`
- `GET /admin/inventory/{variant_id}`
- `PUT /admin/inventory/{variant_id}`
- `GET /admin/support/tickets`
- `PATCH /admin/support/tickets/{ticket_id}`
- `GET /admin/activity`
- `GET /admin/activity/integrity`
- `GET /admin/voice/settings`
- `PUT /admin/voice/settings`
- `POST /admin/voice/process`
- `GET /admin/voice/calls`
- `GET /admin/voice/jobs`
- `GET /admin/voice/suppressions`
- `POST /admin/voice/suppressions`
- `DELETE /admin/voice/suppressions/{user_id}`
- `GET /admin/voice/alerts`
- `GET /admin/voice/stats`

## WebSocket Contract (`/ws`)

Connect with optional query param:

- `sessionId`

If omitted, server creates a session and sends:

```json
{
  "type": "session",
  "payload": {
    "sessionId": "session_000001",
    "expiresAt": "2026-02-23T00:30:00+00:00"
  }
}
```

### Client -> Server Event Types

- `message`
- `typing`
- `ping`
- `pong`

`message` payload fields:

- `content` (required)
- `typing` (optional boolean)
- `stream` (optional boolean)

### Server -> Client Event Types

- `session`
- `response`
- `typing`
- `stream_start`
- `stream_delta`
- `stream_end`
- `error`
- `ping`
- `pong`

## Contract Notes

- Checkout is blocked for unauthenticated users by design.
- Cart is mergeable from guest session into authenticated user account.
- Path parameter names in docs are aligned to actual router definitions.
