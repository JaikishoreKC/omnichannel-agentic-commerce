# Security Guidelines (v1 Current Implementation)

This document describes security controls currently implemented in the codebase.
It is implementation-first, not a policy wishlist.

## Scope

- In scope: REST API, WebSocket API, admin operations, and voice callback ingress.
- Out of scope: compliance frameworks and regulatory workflows.

## Authentication

### Token Model

- Access and refresh tokens are signed with `HS256`.
- Access token default TTL: `900` seconds.
- Refresh token default TTL: `604800` seconds.
- Refresh token rotation is enforced on `/v1/auth/refresh`.

Implementation references:

- `backend/app/core/security.py`
- `backend/app/services/auth_service.py`
- `backend/app/core/config.py`

### Password Security

- Passwords are hashed with PBKDF2-HMAC-SHA256.
- Iterations: `390000`.
- Salt: random 16-byte salt per password.

### Admin MFA

- Admin MFA is configurable.
- Default: `ADMIN_MFA_REQUIRED=false`.
- If enabled, static OTP check is applied at login using
  `ADMIN_MFA_STATIC_CODE`.

## Authorization

- Role-based checks are enforced for admin routes.
- `require_admin` dependency blocks non-admin access.
- Current roles used in runtime: `customer`, `admin`.

Implementation references:

- `backend/app/api/deps.py`
- `backend/app/api/routes/admin_routes.py`

## Session Security

- Anonymous and authenticated sessions are supported.
- `session_id` cookie is set `HttpOnly` with configurable:
  - `SESSION_COOKIE_SECURE` (default `true`)
  - `SESSION_COOKIE_SAMESITE` (default `lax`)

## Request Hardening

Implemented HTTP hardening middleware includes:

- Duplicate critical header rejection (optional toggle).
- Request body size cap enforcement.
- Strict JSON content-type enforcement for mutating API requests.
- Security event metric emission on violations.

Config defaults:

- `REQUEST_MAX_BODY_BYTES=10485760` (10 MB)
- `ENFORCE_JSON_CONTENT_TYPE=true`
- `REJECT_DUPLICATE_CRITICAL_HEADERS=true`

## Rate Limiting

Profiles currently enforced:

- Anonymous: `RATE_LIMIT_ANONYMOUS_PER_MINUTE` (default `120`)
- Authenticated: `RATE_LIMIT_AUTHENTICATED_PER_MINUTE` (default `600`)
- Admin: `RATE_LIMIT_ADMIN_PER_MINUTE` (default `2000`)

Rate limit headers returned:

- `X-RateLimit-Limit`
- `X-RateLimit-Remaining`
- `X-RateLimit-Reset`
- `Retry-After` (for 429)

Behavior:

- Scope-aware keys (`/v1/<group>` + subject).
- Progressive penalties are supported by limiter state.

## Security Response Headers

Middleware sets the following headers:

- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: DENY`
- `Referrer-Policy: strict-origin-when-cross-origin`
- `Permissions-Policy: camera=(), microphone=(), geolocation=()`
- `Content-Security-Policy: default-src 'self'; frame-ancestors 'none'; object-src 'none'`
- `Strict-Transport-Security` is set on HTTPS requests.

## CORS And WebSocket Origin Control

- CORS allowlist is driven by `CORS_ORIGINS`.
- WebSocket origin is validated against configured origins.
- WebSocket heartbeat ping/pong and timeout enforcement are enabled.

## Voice Callback Security

`POST /v1/voice/superu/callback` is protected with:

- HMAC signature verification.
- Timestamp tolerance validation.
- Required secret: `SUPERU_WEBHOOK_SECRET`.

Accepted signature headers:

- `X-SuperU-Signature` or `X-Signature`
- `X-SuperU-Timestamp` or `X-Timestamp`

## Audit And Integrity

- Admin actions are recorded with before/after snapshots.
- Tamper-evident hash chaining is implemented.
- Integrity verification endpoint:
  - `GET /v1/admin/activity/integrity`

## Error Handling And Information Exposure

- API returns normalized error envelopes.
- Validation errors expose field-level issues only.
- Unhandled exceptions return generic internal error messages.

## Data Protection Notes

Current implementation status:

- In-transit protection depends on deployment TLS configuration.
- Data-at-rest encryption is delegated to infrastructure/database layer.
- Secret rotation and enterprise key management are operational concerns and
  are not automated by this codebase.

## Operational Security Checklist

Before production deployment:

1. Set a strong `TOKEN_SECRET`.
1. Enable TLS termination and HSTS at edge/proxy.
1. Restrict `CORS_ORIGINS` to trusted origins.
1. Enable `ADMIN_MFA_REQUIRED` and set `ADMIN_MFA_STATIC_CODE`.
1. Configure and protect all SuperU webhook secrets if voice callbacks are used.
1. Tune rate-limit values for expected traffic.
1. Replace default admin credentials seeded in in-memory store.
