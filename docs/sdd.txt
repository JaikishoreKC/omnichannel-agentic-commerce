# System Design Document (Current v1)

## Purpose

This document describes the detailed design of the current implementation for
`omnichannel-agentic-commerce`.

## Design Scope

### In Scope

- Web channel implementation (responsive UI).
- REST and WebSocket conversational commerce APIs.
- Guest session/cart flows and authenticated checkout.
- Session and cart continuity across guest -> authenticated transition.
- Account-linked conversation continuity and preference memory.
- Admin controls and SuperU voice-recovery orchestration.

### Out Of Scope (Current)

- Native mobile app.
- Native kiosk app.
- Compliance/regulatory programs.
- Real external payment processor.

## System Context

```text
Web Client
  -> FastAPI Routes + WebSocket
  -> Orchestrator
  -> Agents
  -> Services
  -> Repositories
  -> In-memory store (default) + optional Mongo/Redis adapters
  -> External integrations (LLM provider, SuperU)
```

## Runtime Modules

| Module | Key Responsibility |
| --- | --- |
| `backend/app/main.py` | FastAPI app setup, middleware stack, `/ws`, `/health`, `/metrics` |
| `backend/app/api/routes/*` | Route handlers for auth/products/cart/orders/sessions/interactions/memory/admin/voice callback |
| `backend/app/orchestrator/*` | Intent classification, context build, action extraction, routing, formatting |
| `backend/app/agents/*` | Domain action execution for product/cart/order/support/memory |
| `backend/app/services/*` | Business logic and policy enforcement |
| `backend/app/repositories/*` | Data access over store and optional external adapters |
| `backend/app/infrastructure/*` | LLM, SuperU, rate-limiter, metrics, persistence helpers |
| `backend/app/store/in_memory.py` | Primary in-process state model and seed data |

## Identity, Session, And Cart Design

### Identity Modes

- `guest`: no bearer token; session and cart are still available.
- `authenticated`: bearer token present; account-scoped routes and memory enabled.
- `admin`: authenticated user with `role=admin` for admin endpoints.

### Session Lifecycle

- Session id source precedence:
  1. `X-Session-Id` header
  1. `session_id` cookie
  1. server-created new session
- Session TTL: 30 minutes inactivity (`SessionService._expiry_minutes=30`).
- Session contains both `context.conversation` and `context.shopping` data.

### Guest -> Auth Session Resolution

On register/login and authenticated interaction history retrieval:

1. Optional guest session id is read.
2. Guest cart is merged into user cart when present.
3. `resolve_user_session(...)` reuses latest active user session when possible.
4. Identity channel linkage is recorded.
5. Response includes resolved `sessionId`.

This is the primary continuity mechanism across channel surfaces.

### Cart Lifecycle And Rules

- Cart TTL: 24 hours.
- Status values: `active`, `abandoned`, `converted`.
- Merge key on guest->user migration: `productId + variantId`.
- Quantity merge cap: max 50 per line item.
- Guest discount is carried only if user cart has no discount.
- Guest cart record is removed after successful merge.

### Checkout Gate

- Order creation endpoint requires authenticated user.
- `Idempotency-Key` header is mandatory on `POST /v1/orders`.
- Guest checkout attempts are blocked by auth dependency.

## Orchestration Design

### Processing Pipeline

1. Collect recent interaction history for session.
2. Fallback to memory history when session history is empty (authenticated user).
3. Classify intent (rule-first, optional LLM refinement).
4. Build context (session + cart + optional memory snapshot).
5. Extract one or more actions.
6. Route actions to target agent(s).
7. Execute actions and aggregate results.
8. Format transport payload.
9. Persist interaction + update session conversation state.
10. Trigger async memory recording for authenticated users.

### Intent Model (Current)

- Product discovery:
  - `product_search`
  - `search_and_add_to_cart`
- Cart:
  - `add_to_cart`
  - `add_multiple_to_cart`
  - `apply_discount`
  - `update_cart`
  - `adjust_cart_quantity`
  - `remove_from_cart`
  - `clear_cart`
  - `view_cart`
- Order:
  - `checkout`
  - `order_status`
  - `change_order_address`
  - `cancel_order`
  - `request_refund`
  - `multi_status`
- Memory:
  - `show_memory`
  - `save_preference`
  - `forget_preference`
  - `clear_memory`
- Support:
  - `support_escalation`
  - `support_status`
  - `support_close`
- Fallback:
  - `general_question`

### Rule-First + Optional LLM

- Rules always produce a baseline intent.
- LLM is optional (`LLM_ENABLED=true`).
- LLM override is accepted only if confidence is high enough.
- LLM calls are protected by a circuit breaker.

## Memory Design

### Persistence Model

Memory is account-scoped and keyed by `userId`.

Stored sections:

- `preferences`
  - `size`
  - `brandPreferences`
  - `categories`
  - `stylePreferences`
  - `colorPreferences`
  - `priceRange {min,max}`
- `interactionHistory` (bounded list, last 200)
- `productAffinities`
  - `brands`, `categories`, `products`, `priceRanges`, `features`

### Write Rules

- Guest users: no memory write.
- Authenticated users: interaction records append summary + affinity counters.
- Explicit preference commands update/forget/clear preference values.

### Read Rules

- `/v1/memory*` endpoints require authentication.
- `GET /v1/interactions/history` for authenticated users can synthesize history
  from memory if session messages are unavailable.

## Order And Payment Design

### Order Creation

- Validate idempotency key and return existing order if duplicate key is seen.
- Load authenticated user cart and enforce non-empty cart.
- Reserve inventory for order items.
- Authorize payment via `PaymentService`.
- Persist order + mark cart converted + commit inventory + send notification.

### Payment Implementation Note

Current payment authorization is a local stub:

- Validates `type=card` and non-empty token.
- Returns synthetic transaction id (`txn_*`).

No external payment processor is integrated in current scope.

## Voice Recovery Design (SuperU)

### Subsystem Components

- `VoiceRecoveryService`: enqueue/process/poll/alerts orchestration.
- `SuperUClient`: outbound-call API client and webhook signature verifier.
- Admin APIs under `/v1/admin/voice/*`.
- Callback endpoint: `POST /v1/voice/superu/callback`.

### Job Lifecycle

Typical statuses:

- Job: `queued`, `retrying`, `processing`, `completed`, `cancelled`, `dead_letter`.
- Call event outcomes include `initiated`, `in_progress`, `completed`, `failed`, `suppressed`, `skipped`.

### Guardrails

- Quiet hours (timezone-aware).
- Max attempts per cart.
- Max calls per user per day.
- Max calls per day.
- Daily budget cap.
- User suppression list.
- Global kill switch.

### Callback Integrity

- HMAC SHA256 signature over `<timestamp>.<raw_body>`.
- Headers supported:
  - `X-SuperU-Signature` or `X-Signature`
  - `X-SuperU-Timestamp` or `X-Timestamp`
- Timestamp tolerance enforced.

## Security And Resilience

### Security Controls

- JWT auth + refresh rotation.
- Role checks for admin routes.
- Rate limiting by anonymous/authenticated/admin profile.
- Request body size cap.
- JSON content-type enforcement for mutating API calls.
- Duplicate critical-header rejection.
- Response security headers (CSP, frame/type/referrer/permissions policies).
- WebSocket origin validation.

### Resilience Behaviors

- Graceful fallback to rule-based classification when LLM is unavailable.
- WebSocket heartbeat ping/pong with timeout-based disconnect.
- Async memory write so chat latency path is not blocked.

## Persistence And Consistency

### Default Mode

- In-process in-memory store.
- Fast local development, no cross-restart durability.

### External Services Mode

- Enable with `ENABLE_EXTERNAL_SERVICES=true`.
- Mongo/Redis managers initialize repository adapter paths.
- State snapshots are persisted on mutating HTTP requests.

## Observability

### Health Endpoint

`GET /health` reports:

- Mongo/Redis status.
- state persistence enabled flag.
- LLM circuit-breaker status.
- Voice scheduler/provider/runtime flags.

### Metrics Endpoint

`GET /metrics` provides Prometheus metrics including HTTP volume/errors/latency,
checkout counters, and security event counters.

## Testing Alignment

- Backend unit/integration tests under `backend/tests`.
- Frontend lint/build and Playwright E2E under `frontend/tests/e2e`.
- Local end-to-end validation script: `scripts/validate_local.ps1`.

## Deferred Engineering Items

- Native mobile and kiosk clients using same API/WebSocket contracts.
- Production payment provider and reconciliation workflows.
- Compliance/regulatory controls and evidence workflows.
