# Implementation Blueprint (Current Codebase)

## Overview

This blueprint reflects the current implementation structure and how to build,
run, and extend it.

## Repository Structure

```text
omnichannel-agentic-commerce/
  backend/
    app/
      api/
        routes/
      agents/
      orchestrator/
      services/
      repositories/
      infrastructure/
      core/
      models/
      scripts/
      store/
      container.py
      main.py
    tests/
    requirements.txt
    requirements-perf.txt
    pytest.ini

  frontend/
    src/
      App.tsx
      api.ts
      styles.css
      types.ts
    tests/e2e/
    package.json
    vite.config.ts
    playwright.config.ts

  docs/
  monitoring/
  scripts/
  docker-compose.yml
  README.md
```

## Backend Module Responsibilities

| Module | Responsibility |
| --- | --- |
| `api/routes/*` | REST endpoints and webhook ingress |
| `api/deps.py` | Auth/session dependency resolution |
| `main.py` | FastAPI app setup, middleware, websocket endpoint |
| `agents/*` | Domain-specific execution units (product/cart/order/support/memory) |
| `orchestrator/*` | Intent classification, action extraction, routing, response formatting |
| `services/*` | Business logic (auth, cart, order, memory, voice, admin, etc.) |
| `repositories/*` | Storage abstraction over in-memory and optional Mongo/Redis |
| `infrastructure/*` | LLM client, SuperU client, rate limiter, metrics, persistence adapters |
| `store/in_memory.py` | Primary in-memory state model and seed data |
| `scripts/*` | Index creation, DB bootstrap, performance smoke |
| `container.py` | Dependency wiring and singleton initialization |

## Frontend Module Responsibilities

| Module | Responsibility |
| --- | --- |
| `src/App.tsx` | Main UI, routing behavior, chat panel, auth/cart/catalog rendering |
| `src/api.ts` | REST and WebSocket client wrappers |
| `src/styles.css` | Tailwind layers and shared style tokens |
| `src/types.ts` | API-facing TypeScript contracts |
| `tests/e2e/*` | Playwright P0 user-journey coverage |

## Runtime Data Flow

1. Client sends REST request or WebSocket message.
1. API dependencies resolve identity and session context.
1. Middleware applies request hardening, rate limits, and metrics.
1. Orchestrator classifies intent, extracts actions, routes to agents.
1. Agent/service executes business logic using repositories.
1. Interaction and session context are recorded.
1. Memory is updated asynchronously for authenticated users.
1. Mutating requests trigger state persistence snapshot when external
   persistence is enabled.

## Persistence Modes

### Mode A: In-Memory (default)

- `ENABLE_EXTERNAL_SERVICES=false`
- Runtime state lives in process memory.

### Mode B: External Services

- `ENABLE_EXTERNAL_SERVICES=true`
- Mongo and Redis managers are initialized.
- Repository adapters and state persistence are active.

## Build And Run Order

## 1) Backend

```bash
cd backend
python -m venv .venv
# activate env
pip install -r requirements.txt
python -m uvicorn app.main:app --reload --port 8000
```

## 2) Frontend

```bash
cd frontend
npm install
npm run dev
```

## 3) Optional Mongo Index + Bootstrap

```bash
cd backend
python -m app.scripts.create_indexes
python -m app.scripts.bootstrap_db
```

## 4) Optional Docker Compose

```bash
docker compose up --build
```

## Test And Validation Pipeline

### Backend

```bash
cd backend
pytest tests -q --cov=app --cov-fail-under=80
```

### Frontend

```bash
cd frontend
npm run lint
npm run build
npm run test:e2e
```

### Full Local Validation (PowerShell)

```powershell
./scripts/validate_local.ps1
```

## Extension Blueprint

### Adding A New Agent Capability

1. Add or extend intent rules in `orchestrator/intent_classifier.py`.
1. Map intent to action in `orchestrator/action_extractor.py`.
1. Map intent to target agent in `orchestrator/agent_router.py`.
1. Implement agent behavior in `agents/*` and supporting service methods.
1. Add integration and unit tests under `backend/tests`.

### Adding A New REST Endpoint

1. Define request schema in `models/schemas.py` if needed.
1. Add route handler in `api/routes/*`.
1. Reuse or add service/repository functions.
1. Add auth dependency (`get_current_user`, `require_admin`, etc.) as needed.
1. Add tests and update docs.

### Adding A New Channel (future mobile/kiosk)

1. Reuse existing API + websocket contracts.
1. Pass channel metadata (`X-Channel` or interaction payload channel field).
1. Reuse session resolution and identity linking flow.
1. Build channel-specific UI shell; keep orchestration/business logic shared.

## Current Deferred Areas

- Native mobile shell and native kiosk shell.
- Production payment gateway integration.
- Compliance and regulatory workflow automation.
