============================= test session starts =============================
platform win32 -- Python 3.10.11, pytest-8.4.1, pluggy-1.6.0
rootdir: D:\Projects\omnichannel-agentic-commerce\backend
configfile: pytest.ini
plugins: anyio-4.9.0, asyncio-1.3.0, cov-6.2.1
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 167 items

tests\integration\test_admin_activity_integrity.py F                     [  0%]
tests\integration\test_admin_categories_support_and_brand.py FFF         [  2%]
tests\integration\test_admin_inventory_and_support.py FF                 [  3%]
tests\integration\test_admin_product_crud.py F                           [  4%]
tests\integration\test_admin_stats.py F                                  [  4%]
tests\integration\test_admin_voice_recovery.py F                         [  5%]
tests\integration\test_api_contract_errors_and_orders.py F.FF            [  7%]
tests\integration\test_auth_refresh_rotation.py F                        [  8%]
tests\integration\test_http_hardening.py F...                            [ 10%]
tests\integration\test_interaction_history_branches.py F.F               [ 12%]
tests\integration\test_interactions_flow.py FFFFFFFFFFFFF.FFFF           [ 23%]
tests\integration\test_memory_controls_and_history.py FFF                [ 25%]
tests\integration\test_personalized_recommendations.py F                 [ 25%]
tests\integration\test_refund_flow.py FF                                 [ 26%]
tests\integration\test_session_continuity.py FF                          [ 28%]
tests\integration\test_voice_webhook_callback.py F.                      [ 29%]
tests\integration\test_voice_webhook_route_errors.py ......              [ 32%]
tests\integration\test_websocket_flow.py F..F.F                          [ 36%]
tests\nl_eval\test_nl_accuracy_gate.py .                                 [ 37%]
tests\nl_eval\test_nl_intent_and_actions.py ....................         [ 49%]
tests\unit\test_admin_activity_service.py FF                             [ 50%]
tests\unit\test_auth_totp.py EEE                                         [ 52%]
tests\unit\test_base_agent.py .                                          [ 52%]
tests\unit\test_circuit_breaker_and_classifier.py ...............        [ 61%]
tests\unit\test_guest_cart_transfer_on_login.py F                        [ 62%]
tests\unit\test_guest_checkout_guard.py F                                [ 62%]
tests\unit\test_llm_client.py ................                           [ 72%]
tests\unit\test_metrics_collector.py .                                   [ 73%]
tests\unit\test_mongo_indexes.py ..                                      [ 74%]
tests\unit\test_perf_smoke_script.py ...                                 [ 76%]
tests\unit\test_rate_limiter.py ..                                       [ 77%]
tests\unit\test_repositories.py .....F....F.F                            [ 85%]
tests\unit\test_repository_fallbacks.py ...                              [ 86%]
tests\unit\test_scripts_bootstrap_and_indexes.py .....                   [ 89%]
tests\unit\test_state_persistence_and_clients.py ....                    [ 92%]
tests\unit\test_store_state_snapshot.py .                                [ 92%]
tests\unit\test_superu_client.py .......                                 [ 97%]
tests\unit\test_voice_recovery_service.py FFFFF                          [100%]

=================================== ERRORS ====================================
_____________ ERROR at setup of test_admin_login_with_valid_totp ______________
tests\unit\test_auth_totp.py:25: in auth_service
    return AuthService(mock_store, settings, mock_repository)
E   TypeError: AuthService.__init__() takes 3 positional arguments but 4 were given
____________ ERROR at setup of test_admin_login_with_invalid_totp _____________
tests\unit\test_auth_totp.py:25: in auth_service
    return AuthService(mock_store, settings, mock_repository)
E   TypeError: AuthService.__init__() takes 3 positional arguments but 4 were given
______________ ERROR at setup of test_customer_login_skips_totp _______________
tests\unit\test_auth_totp.py:25: in auth_service
    return AuthService(mock_store, settings, mock_repository)
E   TypeError: AuthService.__init__() takes 3 positional arguments but 4 were given
================================== FAILURES ===================================
__________ test_admin_activity_integrity_endpoint_detects_tampering ___________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_activity_integrity.py:21: in test_admin_activity_integrity_endpoint_detects_tampering
    ???
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_activity_integrity.py:14: in _admin_headers
    ???
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
________________ test_admin_category_crud_and_activity_logging ________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_categories_support_and_brand.py:17: in test_admin_category_crud_and_activity_logging
    ???
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_categories_support_and_brand.py:11: in _admin_headers
    ???
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
______________ test_support_ticket_lifecycle_via_chat_and_admin _______________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_categories_support_and_brand.py:86: in test_support_ticket_lifecycle_via_chat_and_admin
    ???
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_categories_support_and_brand.py:11: in _admin_headers
    ???
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
_________________ test_product_brand_filter_and_brand_search __________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_categories_support_and_brand.py:110: in test_product_brand_filter_and_brand_search
    ???
E   assert 0 >= 1
E    +  where 0 = len([])
___________ test_admin_can_update_inventory_and_product_stock_flag ____________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_inventory_and_support.py:18: in test_admin_can_update_inventory_and_product_stock_flag
    ???
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_inventory_and_support.py:11: in _admin_headers
    ???
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
_________ test_support_escalation_creates_ticket_and_stats_reflect_it _________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_inventory_and_support.py:66: in test_support_escalation_creates_ticket_and_stats_reflect_it
    ???
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_inventory_and_support.py:11: in _admin_headers
    ???
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
_______________________ test_admin_can_manage_products ________________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_product_crud.py:13: in test_admin_can_manage_products
    ???
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
____________________ test_admin_stats_requires_admin_role _____________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_stats.py:17: in test_admin_stats_requires_admin_role
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_____________ test_admin_voice_recovery_endpoints_and_processing ______________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_voice_recovery.py:38: in test_admin_voice_recovery_endpoints_and_processing
    ???
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_admin_voice_recovery.py:31: in _admin_headers
    ???
E   assert 401 == 200
E    +  where 401 = <Response [401 Unauthorized]>.status_code
____________ test_orders_create_returns_201_for_authenticated_user ____________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_api_contract_errors_and_orders.py:17: in test_orders_create_returns_201_for_authenticated_user
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_________________ test_order_shipping_address_update_endpoint _________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_api_contract_errors_and_orders.py:98: in test_order_shipping_address_update_endpoint
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
__________ test_order_shipping_address_update_rejected_after_refund ___________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_api_contract_errors_and_orders.py:156: in test_order_shipping_address_update_rejected_after_refund
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_____________ test_refresh_token_rotation_revokes_previous_token ______________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_auth_refresh_rotation.py:16: in test_refresh_token_rotation_revokes_previous_token
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
________________ test_http_responses_include_security_headers _________________
  + Exception Group Traceback (most recent call last):
  |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | exceptiongroup.ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |   File "D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_http_hardening.py", line 11, in test_http_responses_include_security_headers
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 465, in get
    |     return super().get(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1053, in get
    |     return self.request(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 437, in request
    |     return super().request(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 340, in handle_request
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 337, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py", line 458, in result
    |     return self.__get_result()
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py", line 403, in __get_result
    |     raise self._exception
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py", line 187, in __call__
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\metrics.py", line 23, in collect_http_metrics
    |     response = await call_next(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    |     raise app_exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\rate_limiting.py", line 47, in enforce_rate_limits
    |     return await call_next(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    |     raise app_exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\request_hardening.py", line 46, in enforce_request_hardening
    |     return await call_next(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    |     raise app_exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\security_headers.py", line 6, in apply_response_security_headers
    |     response = await call_next(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    |     raise app_exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py", line 215, in run_endpoint_function
    |     return await run_in_threadpool(dependant.call, **values)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\concurrency.py", line 37, in run_in_threadpool
    |     return await anyio.to_thread.run_sync(func)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\to_thread.py", line 56, in run_sync
    |     return await get_async_backend().run_sync_in_worker_thread(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\_backends\_asyncio.py", line 2470, in run_sync_in_worker_thread
    |     return await future
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\_backends\_asyncio.py", line 967, in run
    |     result = context.run(func, *args)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\main.py", line 200, in health
    |     "runtimeEnabled": bool(voice_recovery_service.get_settings().get("enabled", False)),
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\services\voice_recovery_service.py", line 71, in get_settings
    |     return voice_settings.get_settings(self.voice_repository)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\services\voice\settings.py", line 8, in get_settings
    |     settings = voice_repository.get_settings()
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\repositories\voice_repository.py", line 17, in get_settings
    |     collection = self._mongo_db()["voice_settings"]
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\repositories\voice_repository.py", line 138, in _mongo_db
    |     raise RuntimeError("Mongo client not connected")
    | RuntimeError: Mongo client not connected
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_http_hardening.py", line 11, in test_http_responses_include_security_headers
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 465, in get
    return super().get(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1053, in get
    return self.request(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 437, in request
    return super().request(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 340, in handle_request
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 337, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py", line 458, in result
    return self.__get_result()
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py", line 403, in __get_result
    raise self._exception
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py", line 187, in __call__
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\metrics.py", line 23, in collect_http_metrics
    response = await call_next(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    raise app_exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\rate_limiting.py", line 47, in enforce_rate_limits
    return await call_next(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    raise app_exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\request_hardening.py", line 46, in enforce_request_hardening
    return await call_next(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    raise app_exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\security_headers.py", line 6, in apply_response_security_headers
    response = await call_next(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    raise app_exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py", line 215, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\concurrency.py", line 37, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\_backends\_asyncio.py", line 2470, in run_sync_in_worker_thread
    return await future
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\_backends\_asyncio.py", line 967, in run
    result = context.run(func, *args)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\main.py", line 200, in health
    "runtimeEnabled": bool(voice_recovery_service.get_settings().get("enabled", False)),
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\services\voice_recovery_service.py", line 71, in get_settings
    return voice_settings.get_settings(self.voice_repository)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\services\voice\settings.py", line 8, in get_settings
    settings = voice_repository.get_settings()
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\repositories\voice_repository.py", line 17, in get_settings
    collection = self._mongo_db()["voice_settings"]
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\repositories\voice_repository.py", line 138, in _mongo_db
    raise RuntimeError("Mongo client not connected")
RuntimeError: Mongo client not connected

During handling of the above exception, another exception occurred:
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_http_hardening.py:11: in test_http_responses_include_security_headers
    ???
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:465: in get
    return super().get(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:1053: in get
    return self.request(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:437: in request
    return super().request(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:340: in handle_request
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:337: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py:458: in result
    return self.__get_result()
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py:403: in __get_result
    raise self._exception
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py:187: in __call__
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py:165: in __call__
    await self.app(scope, receive, _send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py:153: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
app\middleware\metrics.py:23: in collect_http_metrics
    response = await call_next(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:156: in call_next
    raise app_exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py:153: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
app\middleware\rate_limiting.py:47: in enforce_rate_limits
    return await call_next(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:156: in call_next
    raise app_exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py:153: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
app\middleware\request_hardening.py:46: in enforce_request_hardening
    return await call_next(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:156: in call_next
    raise app_exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py:153: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
app\middleware\security_headers.py:6: in apply_response_security_headers
    response = await call_next(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:156: in call_next
    raise app_exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:734: in app
    await route.handle(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:288: in handle
    await self.app(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:73: in app
    response = await f(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py:215: in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\concurrency.py:37: in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\to_thread.py:56: in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\_backends\_asyncio.py:2470: in run_sync_in_worker_thread
    return await future
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\_backends\_asyncio.py:967: in run
    result = context.run(func, *args)
app\main.py:200: in health
    "runtimeEnabled": bool(voice_recovery_service.get_settings().get("enabled", False)),
app\services\voice_recovery_service.py:71: in get_settings
    return voice_settings.get_settings(self.voice_repository)
app\services\voice\settings.py:8: in get_settings
    settings = voice_repository.get_settings()
app\repositories\voice_repository.py:17: in get_settings
    collection = self._mongo_db()["voice_settings"]
app\repositories\voice_repository.py:138: in _mongo_db
    raise RuntimeError("Mongo client not connected")
E   RuntimeError: Mongo client not connected
_ test_authenticated_history_builds_fallback_from_memory_when_session_history_is_empty _
tests\integration\test_interaction_history_branches.py:37: in test_authenticated_history_builds_fallback_from_memory_when_session_history_is_empty
    token = _register_user(client, session_id=session_id)
tests\integration\test_interaction_history_branches.py:28: in _register_user
    assert response.status_code == 201
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_ test_process_message_creates_session_when_missing_and_handles_identity_link_failure _
tests\integration\test_interaction_history_branches.py:99: in test_process_message_creates_session_when_missing_and_handles_identity_link_failure
    token = _register_user(client, session_id=seed_session_id)
tests\integration\test_interaction_history_branches.py:28: in _register_user
    assert response.status_code == 201
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
________________ test_interaction_search_and_add_to_cart_guest ________________
tests\integration\test_interactions_flow.py:27: in test_interaction_search_and_add_to_cart_guest
    assert len(payload["data"]["products"]) >= 1
E   assert 0 >= 1
E    +  where 0 = len([])
____________ test_interaction_checkout_requires_auth_then_succeeds ____________
tests\integration\test_interactions_flow.py:73: in test_interaction_checkout_requires_auth_then_succeeds
    assert auth.status_code == 201
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
___________________ test_interaction_parallel_multi_status ____________________
tests\integration\test_interactions_flow.py:100: in test_interaction_parallel_multi_status
    assert auth.status_code == 201
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
___________ test_interaction_single_message_search_and_add_to_cart ____________
tests\integration\test_interactions_flow.py:148: in test_interaction_single_message_search_and_add_to_cart
    assert response.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
____________________ test_interaction_apply_discount_code _____________________
tests\integration\test_interactions_flow.py:171: in test_interaction_apply_discount_code
    assert seed.status_code == 200
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
__________ test_interaction_order_issue_phrase_routes_to_order_agent __________
tests\integration\test_interactions_flow.py:203: in test_interaction_order_issue_phrase_routes_to_order_agent
    assert auth.status_code == 201
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_____________ test_interaction_change_order_address_when_allowed ______________
tests\integration\test_interactions_flow.py:254: in test_interaction_change_order_address_when_allowed
    assert auth.status_code == 201
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
______________ test_interaction_add_by_product_name_and_quantity ______________
tests\integration\test_interactions_flow.py:320: in test_interaction_add_by_product_name_and_quantity
    assert cart.json()["itemCount"] == 2
E   assert 0 == 2
_____ test_interaction_add_to_cart_requests_clarification_when_ambiguous ______
tests\integration\test_interactions_flow.py:338: in test_interaction_add_to_cart_requests_clarification_when_ambiguous
    assert payload["data"]["code"] == "CLARIFICATION_REQUIRED"
E   KeyError: 'code'
______ test_interaction_add_by_product_id_requires_variant_clarification ______
tests\integration\test_interactions_flow.py:358: in test_interaction_add_by_product_id_requires_variant_clarification
    assert payload["data"]["code"] == "CLARIFICATION_REQUIRED"
E   KeyError: 'code'
_______ test_interaction_add_by_product_id_with_size_and_color_succeeds _______
tests\integration\test_interactions_flow.py:377: in test_interaction_add_by_product_id_with_size_and_color_succeeds
    assert "added" in payload["message"].lower()
E   AssertionError: assert 'added' in 'tell me what to add, for example: add 2 running shoes to cart.'
E    +  where 'tell me what to add, for example: add 2 running shoes to cart.' = <built-in method lower of str object at 0x000001BD34686100>()
E    +    where <built-in method lower of str object at 0x000001BD34686100> = 'Tell me what to add, for example: add 2 running shoes to cart.'.lower
____________ test_interaction_add_multiple_items_in_single_message ____________
tests\integration\test_interactions_flow.py:394: in test_interaction_add_multiple_items_in_single_message
    assert "added" in payload["message"].lower()
E   assert 'added' in "i couldn't match those items. try product names like running shoes or hoodie."
E    +  where "i couldn't match those items. try product names like running shoes or hoodie." = <built-in method lower of str object at 0x000001BD33DF2730>()
E    +    where <built-in method lower of str object at 0x000001BD33DF2730> = "I couldn't match those items. Try product names like running shoes or hoodie.".lower
______________ test_interaction_adjust_item_quantity_up_and_down ______________
tests\integration\test_interactions_flow.py:426: in test_interaction_adjust_item_quantity_up_and_down
    assert "updated" in increase.json()["payload"]["message"].lower()
E   assert 'updated' in "i couldn't identify which cart item to adjust."
E    +  where "i couldn't identify which cart item to adjust." = <built-in method lower of str object at 0x000001BD34662730>()
E    +    where <built-in method lower of str object at 0x000001BD34662730> = "I couldn't identify which cart item to adjust.".lower
_____________ test_interaction_remove_partial_quantity_from_cart ______________
tests\integration\test_interactions_flow.py:503: in test_interaction_remove_partial_quantity_from_cart
    assert "remaining quantity is 1" in remove.json()["payload"]["message"].lower()
E   AssertionError: assert 'remaining quantity is 1' in 'your cart is empty.'
E    +  where 'your cart is empty.' = <built-in method lower of str object at 0x000001BD345D8170>()
E    +    where <built-in method lower of str object at 0x000001BD345D8170> = 'Your cart is empty.'.lower
________ test_interaction_llm_planner_executes_multi_step_cart_actions ________
tests\integration\test_interactions_flow.py:560: in test_interaction_llm_planner_executes_multi_step_cart_actions
    assert cart.json()["itemCount"] == 3
E   assert 0 == 3
__________ test_interaction_planner_atomic_mode_reports_step_errors ___________
tests\integration\test_interactions_flow.py:572: in test_interaction_planner_atomic_mode_reports_step_errors
    planner_settings = replace(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\dataclasses.py:1453: in replace
    return obj.__class__(**changes)
E   TypeError: Settings.__init__() got an unexpected keyword argument 'openai_api_key'
________ test_interaction_planner_canary_zero_disables_planner_attempt ________
tests\integration\test_interactions_flow.py:630: in test_interaction_planner_canary_zero_disables_planner_attempt
    planner_settings = replace(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\dataclasses.py:1453: in replace
    return obj.__class__(**changes)
E   TypeError: Settings.__init__() got an unexpected keyword argument 'openai_api_key'
_________________ test_chat_memory_save_show_forget_and_clear _________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_memory_controls_and_history.py:24: in test_chat_memory_save_show_forget_and_clear
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
___ test_interaction_history_endpoint_returns_transcript_for_guest_session ____
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_memory_controls_and_history.py:100: in test_interaction_history_endpoint_returns_transcript_for_guest_session
    ???
E   assert 404 == 200
E    +  where 404 = <Response [404 Not Found]>.status_code
____________ test_login_merges_guest_cart_into_existing_user_cart _____________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_memory_controls_and_history.py:120: in test_login_merges_guest_cart_into_existing_user_cart
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
______________ test_recommendations_use_user_preferred_category _______________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_personalized_recommendations.py:22: in test_recommendations_use_user_preferred_category
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
________________ test_refund_endpoint_marks_order_as_refunded _________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_refund_flow.py:49: in test_refund_endpoint_marks_order_as_refunded
    ???
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_refund_flow.py:15: in _register_and_get_token
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
__________________ test_chat_refund_intent_uses_order_agent ___________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_refund_flow.py:71: in test_chat_refund_intent_uses_order_agent
    ???
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_refund_flow.py:15: in _register_and_get_token
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_________ test_login_reuses_existing_user_session_for_chat_continuity _________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_session_continuity.py:25: in test_login_reuses_existing_user_session_for_chat_continuity
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_____ test_websocket_switches_to_existing_user_session_when_authenticated _____
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_session_continuity.py:74: in test_websocket_switches_to_existing_user_session_when_authenticated
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
___________ test_superu_callback_ingests_signed_event_idempotently ____________
  + Exception Group Traceback (most recent call last):
  |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 177, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\_backends\_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | exceptiongroup.ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\runner.py", line 344, in from_call
    |     result: TResult | None = func()
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\runner.py", line 246, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\logging.py", line 850, in pytest_runtest_call
    |     yield
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\capture.py", line 900, in pytest_runtest_call
    |     return (yield)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\skipping.py", line 263, in pytest_runtest_call
    |     return (yield)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\runner.py", line 178, in pytest_runtest_call
    |     item.runtest()
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\python.py", line 1671, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_hooks.py", line 512, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 167, in _multicall
    |     raise exception
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 139, in _multicall
    |     teardown.throw(exception)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 53, in run_old_style_hookwrapper
    |     return result.get_result()
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_result.py", line 103, in get_result
    |     raise exc.with_traceback(tb)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 38, in run_old_style_hookwrapper
    |     res = yield
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\pluggy\_callers.py", line 121, in _multicall
    |     res = hook_impl.function(*args)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\_pytest\python.py", line 157, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |   File "D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_voice_webhook_callback.py", line 74, in test_superu_callback_ingests_signed_event_idempotently
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 538, in post
    |     return super().post(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1144, in post
    |     return self.request(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 437, in request
    |     return super().request(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 825, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1014, in _send_single_request
    |     response = transport.handle_request(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 340, in handle_request
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 337, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py", line 458, in result
    |     return self.__get_result()
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py", line 403, in __get_result
    |     raise self._exception
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\applications.py", line 112, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py", line 187, in __call__
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\metrics.py", line 23, in collect_http_metrics
    |     response = await call_next(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    |     raise app_exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\rate_limiting.py", line 78, in enforce_rate_limits
    |     response = await call_next(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    |     raise app_exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\request_hardening.py", line 107, in enforce_request_hardening
    |     return await call_next(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    |     raise app_exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\security_headers.py", line 6, in apply_response_security_headers
    |     response = await call_next(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    |     raise app_exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    |     await self.app(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    |     await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 714, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 734, in app
    |     await route.handle(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 288, in handle
    |     await self.app(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 76, in app
    |     await wrap_app_handling_exceptions(app, request)(scope, receive, send)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    |     raise exc
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    |     await app(scope, receive, sender)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 73, in app
    |     response = await f(request)
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py", line 302, in app
    |     raw_response = await run_endpoint_function(
    |   File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    |     return await dependant.call(**values)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\api\routes\voice_webhook_routes.py", line 36, in handle_superu_callback
    |     result = voice_recovery_service.ingest_provider_callback(payload=payload)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\services\voice_recovery_service.py", line 169, in ingest_provider_callback
    |     calls = self.voice_repository.list_calls(limit=1000)
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\repositories\voice_repository.py", line 84, in list_calls
    |     collection = self._mongo_db()["voice_calls"]
    |   File "D:\Projects\omnichannel-agentic-commerce\backend\app\repositories\voice_repository.py", line 138, in _mongo_db
    |     raise RuntimeError("Mongo client not connected")
    | RuntimeError: Mongo client not connected
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_voice_webhook_callback.py", line 74, in test_superu_callback_ingests_signed_event_idempotently
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 538, in post
    return super().post(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1144, in post
    return self.request(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 437, in request
    return super().request(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 825, in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 914, in send
    response = self._send_handling_auth(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 942, in _send_handling_auth
    response = self._send_handling_redirects(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 979, in _send_handling_redirects
    response = self._send_single_request(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py", line 1014, in _send_single_request
    response = transport.handle_request(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 340, in handle_request
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py", line 337, in handle_request
    portal.call(self.app, scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py", line 290, in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py", line 458, in result
    return self.__get_result()
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py", line 403, in __get_result
    raise self._exception
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py", line 221, in _call_func
    retval = await retval_or_awaitable
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\applications.py", line 1054, in __call__
    await super().__call__(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\applications.py", line 112, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py", line 187, in __call__
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\metrics.py", line 23, in collect_http_metrics
    response = await call_next(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    raise app_exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\rate_limiting.py", line 78, in enforce_rate_limits
    response = await call_next(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    raise app_exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\request_hardening.py", line 107, in enforce_request_hardening
    return await call_next(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    raise app_exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 176, in __call__
    with recv_stream, send_stream, collapse_excgroups():
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py", line 153, in __exit__
    self.gen.throw(typ, value, traceback)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py", line 82, in collapse_excgroups
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 178, in __call__
    response = await self.dispatch_func(request, call_next)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\middleware\security_headers.py", line 6, in apply_response_security_headers
    response = await call_next(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 156, in call_next
    raise app_exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\cors.py", line 85, in __call__
    await self.app(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\exceptions.py", line 62, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 714, in __call__
    await self.middleware_stack(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 734, in app
    await route.handle(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 288, in handle
    await self.app(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 76, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py", line 73, in app
    response = await f(request)
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py", line 302, in app
    raw_response = await run_endpoint_function(
  File "C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py", line 213, in run_endpoint_function
    return await dependant.call(**values)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\api\routes\voice_webhook_routes.py", line 36, in handle_superu_callback
    result = voice_recovery_service.ingest_provider_callback(payload=payload)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\services\voice_recovery_service.py", line 169, in ingest_provider_callback
    calls = self.voice_repository.list_calls(limit=1000)
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\repositories\voice_repository.py", line 84, in list_calls
    collection = self._mongo_db()["voice_calls"]
  File "D:\Projects\omnichannel-agentic-commerce\backend\app\repositories\voice_repository.py", line 138, in _mongo_db
    raise RuntimeError("Mongo client not connected")
RuntimeError: Mongo client not connected

During handling of the above exception, another exception occurred:
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\integration\test_voice_webhook_callback.py:74: in test_superu_callback_ingests_signed_event_idempotently
    ???
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:538: in post
    return super().post(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:1144: in post
    return self.request(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:437: in request
    return super().request(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:825: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:914: in send
    response = self._send_handling_auth(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\httpx\_client.py:1014: in _send_single_request
    response = transport.handle_request(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:340: in handle_request
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:337: in handle_request
    portal.call(self.app, scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py:290: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py:458: in result
    return self.__get_result()
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\concurrent\futures\_base.py:403: in __get_result
    raise self._exception
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\anyio\from_thread.py:221: in _call_func
    retval = await retval_or_awaitable
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\applications.py:112: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py:187: in __call__
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\errors.py:165: in __call__
    await self.app(scope, receive, _send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py:153: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
app\middleware\metrics.py:23: in collect_http_metrics
    response = await call_next(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:156: in call_next
    raise app_exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py:153: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
app\middleware\rate_limiting.py:78: in enforce_rate_limits
    response = await call_next(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:156: in call_next
    raise app_exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py:153: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
app\middleware\request_hardening.py:107: in enforce_request_hardening
    return await call_next(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:156: in call_next
    raise app_exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:176: in __call__
    with recv_stream, send_stream, collapse_excgroups():
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\contextlib.py:153: in __exit__
    self.gen.throw(typ, value, traceback)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_utils.py:82: in collapse_excgroups
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:178: in __call__
    response = await self.dispatch_func(request, call_next)
app\middleware\security_headers.py:6: in apply_response_security_headers
    response = await call_next(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:156: in call_next
    raise app_exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\base.py:141: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\middleware\exceptions.py:62: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:714: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:734: in app
    await route.handle(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:288: in handle
    await self.app(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:76: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\routing.py:73: in app
    response = await f(request)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py:302: in app
    raw_response = await run_endpoint_function(
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\fastapi\routing.py:213: in run_endpoint_function
    return await dependant.call(**values)
app\api\routes\voice_webhook_routes.py:36: in handle_superu_callback
    result = voice_recovery_service.ingest_provider_callback(payload=payload)
app\services\voice_recovery_service.py:169: in ingest_provider_callback
    calls = self.voice_repository.list_calls(limit=1000)
app\repositories\voice_repository.py:84: in list_calls
    collection = self._mongo_db()["voice_calls"]
app\repositories\voice_repository.py:138: in _mongo_db
    raise RuntimeError("Mongo client not connected")
E   RuntimeError: Mongo client not connected
_________________________ test_websocket_message_flow _________________________
tests\integration\test_websocket_flow.py:20: in test_websocket_message_flow
    assert response["type"] == "response"
E   AssertionError: assert 'session' == 'response'
E     
E     - response
E     + session
_____________________ test_websocket_ping_pong_roundtrip ______________________
tests\integration\test_websocket_flow.py:121: in test_websocket_ping_pong_roundtrip
    assert event["type"] == "pong"
E   AssertionError: assert 'session' == 'pong'
E     
E     - pong
E     + session
_________ test_websocket_recovers_stale_session_and_keeps_cart_state __________
tests\integration\test_websocket_flow.py:174: in test_websocket_recovers_stale_session_and_keeps_cart_state
    add_first = websocket.receive_json()
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:183: in receive_json
    self._raise_on_close(message)
C:\Users\kcjai\AppData\Local\Programs\Python\Python310\lib\site-packages\starlette\testclient.py:147: in _raise_on_close
    raise WebSocketDenialResponse(status_code=status_code, headers=headers, content=b"".join(body))
E   starlette.testclient.WebSocketDenialResponse
________________ test_admin_activity_hash_chain_and_integrity _________________
tests\unit\test_admin_activity_service.py:55: in test_admin_activity_hash_chain_and_integrity
    first = service.record(
app\services\admin_activity_service.py:37: in record
    latest = self.admin_activity_repository.get_latest()
app\repositories\admin_activity_repository.py:35: in get_latest
    row = collection.find_one(sort=[("timestamp", -1)])
E   AttributeError: '_FakeMongoCollection' object has no attribute 'find_one'
_______________ test_admin_activity_integrity_detects_tampering _______________
tests\unit\test_admin_activity_service.py:89: in test_admin_activity_integrity_detects_tampering
    service.record(
app\services\admin_activity_service.py:37: in record
    latest = self.admin_activity_repository.get_latest()
app\repositories\admin_activity_repository.py:35: in get_latest
    row = collection.find_one(sort=[("timestamp", -1)])
E   AttributeError: '_FakeMongoCollection' object has no attribute 'find_one'
___________________ test_guest_cart_is_attached_after_login ___________________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\unit\test_guest_cart_transfer_on_login.py:18: in test_guest_cart_is_attached_after_login
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_____________ test_guest_can_add_to_cart_but_cannot_create_order ______________
D:\Projects\omnichannel-agentic-ai-commerce\backend\tests\unit\test_guest_checkout_guard.py:18: in test_guest_can_add_to_cart_but_cannot_create_order
    ???
E   assert 404 == 201
E    +  where 404 = <Response [404 Not Found]>.status_code
_______________ test_support_repository_roundtrip_open_tickets ________________
tests\unit\test_repositories.py:402: in test_support_repository_roundtrip_open_tickets
    open_tickets = repo.list_open()
app\repositories\support_repository.py:65: in list_open
    return self.list(status="open", limit=500)
app\repositories\support_repository.py:55: in list
    rows = list(collection.find(query).sort("updatedAt", -1).limit(safe_limit))
E   AttributeError: 'FakeCursor' object has no attribute 'limit'
______________ test_notification_repository_roundtrip_in_memory _______________
tests\unit\test_repositories.py:575: in test_notification_repository_roundtrip_in_memory
    assert len(for_user) == 1
E   assert 0 == 1
E    +  where 0 = len([])
_____________ test_admin_activity_repository_roundtrip_in_memory ______________
tests\unit\test_repositories.py:634: in test_admin_activity_repository_roundtrip_in_memory
    rows = repo.list_recent(limit=10)
app\repositories\admin_activity_repository.py:24: in list_recent
    rows = list(collection.find({}).sort("timestamp", -1).limit(safe_limit))
E   AttributeError: 'FakeCursor' object has no attribute 'limit'
__________ test_voice_recovery_processes_abandoned_cart_successfully __________
tests\unit\test_voice_recovery_service.py:213: in test_voice_recovery_processes_abandoned_cart_successfully
    result = service.process_due_work()
app\services\voice_recovery_service.py:55: in process_due_work
    processed = voice_jobs.process_due_jobs(
app\services\voice\jobs.py:82: in process_due_jobs
    all_jobs = voice_repository.list_jobs(limit=1000)
app\repositories\voice_repository.py:54: in list_jobs
    rows = list(collection.find(query).sort("createdAt", -1).limit(limit))
E   AttributeError: 'FakeCursor' object has no attribute 'limit'
_____________ test_voice_recovery_dead_letters_after_max_attempts _____________
tests\unit\test_voice_recovery_service.py:225: in test_voice_recovery_dead_letters_after_max_attempts
    result = service.process_due_work()
app\services\voice_recovery_service.py:55: in process_due_work
    processed = voice_jobs.process_due_jobs(
app\services\voice\jobs.py:82: in process_due_jobs
    all_jobs = voice_repository.list_jobs(limit=1000)
app\repositories\voice_repository.py:54: in list_jobs
    rows = list(collection.find(query).sort("createdAt", -1).limit(limit))
E   AttributeError: 'FakeCursor' object has no attribute 'limit'
______________ test_voice_recovery_kill_switch_cancels_due_jobs _______________
tests\unit\test_voice_recovery_service.py:238: in test_voice_recovery_kill_switch_cancels_due_jobs
    result = service.process_due_work()
app\services\voice_recovery_service.py:55: in process_due_work
    processed = voice_jobs.process_due_jobs(
app\services\voice\jobs.py:82: in process_due_jobs
    all_jobs = voice_repository.list_jobs(limit=1000)
app\repositories\voice_repository.py:54: in list_jobs
    rows = list(collection.find(query).sort("createdAt", -1).limit(limit))
E   AttributeError: 'FakeCursor' object has no attribute 'limit'
__________________ test_voice_recovery_suppression_roundtrip __________________
tests\unit\test_voice_recovery_service.py:248: in test_voice_recovery_suppression_roundtrip
    user_id = next(row["id"] for row in users if row.get("role") == "customer")
E   StopIteration
_________ test_voice_recovery_ingests_provider_callback_idempotently __________
tests\unit\test_voice_recovery_service.py:260: in test_voice_recovery_ingests_provider_callback_idempotently
    processed = service.process_due_work()
app\services\voice_recovery_service.py:55: in process_due_work
    processed = voice_jobs.process_due_jobs(
app\services\voice\jobs.py:82: in process_due_jobs
    all_jobs = voice_repository.list_jobs(limit=1000)
app\repositories\voice_repository.py:54: in list_jobs
    rows = list(collection.find(query).sort("createdAt", -1).limit(limit))
E   AttributeError: 'FakeCursor' object has no attribute 'limit'
=========================== short test summary info ===========================
FAILED tests/integration/test_admin_activity_integrity.py::test_admin_activity_integrity_endpoint_detects_tampering
FAILED tests/integration/test_admin_categories_support_and_brand.py::test_admin_category_crud_and_activity_logging
FAILED tests/integration/test_admin_categories_support_and_brand.py::test_support_ticket_lifecycle_via_chat_and_admin
FAILED tests/integration/test_admin_categories_support_and_brand.py::test_product_brand_filter_and_brand_search
FAILED tests/integration/test_admin_inventory_and_support.py::test_admin_can_update_inventory_and_product_stock_flag
FAILED tests/integration/test_admin_inventory_and_support.py::test_support_escalation_creates_ticket_and_stats_reflect_it
FAILED tests/integration/test_admin_product_crud.py::test_admin_can_manage_products
FAILED tests/integration/test_admin_stats.py::test_admin_stats_requires_admin_role
FAILED tests/integration/test_admin_voice_recovery.py::test_admin_voice_recovery_endpoints_and_processing
FAILED tests/integration/test_api_contract_errors_and_orders.py::test_orders_create_returns_201_for_authenticated_user
FAILED tests/integration/test_api_contract_errors_and_orders.py::test_order_shipping_address_update_endpoint
FAILED tests/integration/test_api_contract_errors_and_orders.py::test_order_shipping_address_update_rejected_after_refund
FAILED tests/integration/test_auth_refresh_rotation.py::test_refresh_token_rotation_revokes_previous_token
FAILED tests/integration/test_http_hardening.py::test_http_responses_include_security_headers
FAILED tests/integration/test_interaction_history_branches.py::test_authenticated_history_builds_fallback_from_memory_when_session_history_is_empty
FAILED tests/integration/test_interaction_history_branches.py::test_process_message_creates_session_when_missing_and_handles_identity_link_failure
FAILED tests/integration/test_interactions_flow.py::test_interaction_search_and_add_to_cart_guest
FAILED tests/integration/test_interactions_flow.py::test_interaction_checkout_requires_auth_then_succeeds
FAILED tests/integration/test_interactions_flow.py::test_interaction_parallel_multi_status
FAILED tests/integration/test_interactions_flow.py::test_interaction_single_message_search_and_add_to_cart
FAILED tests/integration/test_interactions_flow.py::test_interaction_apply_discount_code
FAILED tests/integration/test_interactions_flow.py::test_interaction_order_issue_phrase_routes_to_order_agent
FAILED tests/integration/test_interactions_flow.py::test_interaction_change_order_address_when_allowed
FAILED tests/integration/test_interactions_flow.py::test_interaction_add_by_product_name_and_quantity
FAILED tests/integration/test_interactions_flow.py::test_interaction_add_to_cart_requests_clarification_when_ambiguous
FAILED tests/integration/test_interactions_flow.py::test_interaction_add_by_product_id_requires_variant_clarification
FAILED tests/integration/test_interactions_flow.py::test_interaction_add_by_product_id_with_size_and_color_succeeds
FAILED tests/integration/test_interactions_flow.py::test_interaction_add_multiple_items_in_single_message
FAILED tests/integration/test_interactions_flow.py::test_interaction_adjust_item_quantity_up_and_down
FAILED tests/integration/test_interactions_flow.py::test_interaction_remove_partial_quantity_from_cart
FAILED tests/integration/test_interactions_flow.py::test_interaction_llm_planner_executes_multi_step_cart_actions
FAILED tests/integration/test_interactions_flow.py::test_interaction_planner_atomic_mode_reports_step_errors
FAILED tests/integration/test_interactions_flow.py::test_interaction_planner_canary_zero_disables_planner_attempt
FAILED tests/integration/test_memory_controls_and_history.py::test_chat_memory_save_show_forget_and_clear
FAILED tests/integration/test_memory_controls_and_history.py::test_interaction_history_endpoint_returns_transcript_for_guest_session
FAILED tests/integration/test_memory_controls_and_history.py::test_login_merges_guest_cart_into_existing_user_cart
FAILED tests/integration/test_personalized_recommendations.py::test_recommendations_use_user_preferred_category
FAILED tests/integration/test_refund_flow.py::test_refund_endpoint_marks_order_as_refunded
FAILED tests/integration/test_refund_flow.py::test_chat_refund_intent_uses_order_agent
FAILED tests/integration/test_session_continuity.py::test_login_reuses_existing_user_session_for_chat_continuity
FAILED tests/integration/test_session_continuity.py::test_websocket_switches_to_existing_user_session_when_authenticated
FAILED tests/integration/test_voice_webhook_callback.py::test_superu_callback_ingests_signed_event_idempotently
FAILED tests/integration/test_websocket_flow.py::test_websocket_message_flow
FAILED tests/integration/test_websocket_flow.py::test_websocket_ping_pong_roundtrip
FAILED tests/integration/test_websocket_flow.py::test_websocket_recovers_stale_session_and_keeps_cart_state
FAILED tests/unit/test_admin_activity_service.py::test_admin_activity_hash_chain_and_integrity
FAILED tests/unit/test_admin_activity_service.py::test_admin_activity_integrity_detects_tampering
FAILED tests/unit/test_guest_cart_transfer_on_login.py::test_guest_cart_is_attached_after_login
FAILED tests/unit/test_guest_checkout_guard.py::test_guest_can_add_to_cart_but_cannot_create_order
FAILED tests/unit/test_repositories.py::test_support_repository_roundtrip_open_tickets
FAILED tests/unit/test_repositories.py::test_notification_repository_roundtrip_in_memory
FAILED tests/unit/test_repositories.py::test_admin_activity_repository_roundtrip_in_memory
FAILED tests/unit/test_voice_recovery_service.py::test_voice_recovery_processes_abandoned_cart_successfully
FAILED tests/unit/test_voice_recovery_service.py::test_voice_recovery_dead_letters_after_max_attempts
FAILED tests/unit/test_voice_recovery_service.py::test_voice_recovery_kill_switch_cancels_due_jobs
FAILED tests/unit/test_voice_recovery_service.py::test_voice_recovery_suppression_roundtrip
FAILED tests/unit/test_voice_recovery_service.py::test_voice_recovery_ingests_provider_callback_idempotently
ERROR tests/unit/test_auth_totp.py::test_admin_login_with_valid_totp - TypeEr...
ERROR tests/unit/test_auth_totp.py::test_admin_login_with_invalid_totp - Type...
ERROR tests/unit/test_auth_totp.py::test_customer_login_skips_totp - TypeErro...
================== 57 failed, 107 passed, 3 errors in 37.15s ==================
